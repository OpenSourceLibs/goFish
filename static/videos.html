<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1"> 
        <script src="scripts/ProcessVideo.js" type="text/javascript"></script>
    </head>
{{if .VideosLoaded}}
    <div style="float:left;">
        <video width="320" height="240" controls class="video" id="left">
            <source src="static/videos/{{.LeftVideoSrc}}" type="video/mp4">
                Video tag is not supported by your current browser.
        </video>
        <br>
        <input type="range" min="0" max="100" id="left-slider" step="0.01" style="width:100%;">
        <div id="left-offset"></div>
    </div>
    <div>
        <video width="320" height="240" controls class="video" id="right">
            <source src="static/videos/{{.RightVideoSrc}}" type="video/mp4">
                Video tag is not supported by your current browser.
        </video>
        <br>
        <input type="range" min="0" max="100" id="right-slider" step="0.01" style="width:320px;">
        <div id="right-offset"></div>
    </div>
    <br>
    <button onclick="processor.play()">Play</button>
    <button onclick="processor.sync()">Play In-Sync</button>
    <button onclick="processor.pause()">Pause</button>
    <br>
    <canvas id="left-right-video" width="640" height="240"></canvas>
    <br>
    <input type="range" value="0" min="0" max="0" id="scrubber" step="0.01" style="width:640px;">
{{end}}
<h3>Select the videos you wish to display</h3>
<h3>Select Videos</h3>
<form method="post" enctype="multipart/form-data">
    <input type="file" name="select-video-1" /><br>
    <input type="file" name="select-video-2" /><br>
    <input type="submit" value="Select Videos" />
</form>

<h3>Upload Videos</h3>
<form method="post" enctype="multipart/form-data">
    <input type="file" name="upload-files" multiple><br>
    <input type="submit" value="Upload Videos" />
</form>

<script> 
    document.addEventListener("DOMContentLoaded", () => {
        processor.doLoad();
    });

    window.onload = function()
    {   
        handleSlider("left-slider", "left-offset", processor.leftVideo);
        handleSlider("right-slider", "right-offset", processor.rightVideo);

        // *** TODO: This needs work, and causes an AbortError semi-regularly. ***
        var scrubber = document.getElementById("scrubber");
        var start_val, diff=0;
        scrubber.onmousedown = function() {
            processor.pause();
            start_val = scrubber.value;
        }
        
        scrubber.onmouseup = function() {
            processor.play();
        }
        
        var lastDiff;
        scrubber.oninput = function(e) {
            var lOffset = parseFloat(document.getElementById("left-offset").innerText);
            var rOffset = parseFloat(document.getElementById("right-offset").innerText);
            diff = scrubber.value / (scrubber.max + Math.min(lOffset, rOffset));
            processor.adjustVideo(diff);
            console.log(scrubber.value);
        }
        // *** End block ***    
    }

    function handleSlider(id, divOut, video)
    { 
        var slider = document.getElementById(id);
        var output = document.getElementById(divOut);
        output.innerHTML = slider.value;
        slider.max = video.duration;

        slider.oninput = function () {
            output.innerHTML = this.value;
        }
    }

</script>
</html>